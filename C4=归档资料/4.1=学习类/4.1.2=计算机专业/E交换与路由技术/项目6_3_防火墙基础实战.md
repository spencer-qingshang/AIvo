# 项目6-3：防火墙基础实战手册

> **核心目标**：划分 Trust 和 Untrust 区域，配置安全策略允许内网访问外网。
> **场景**：USG6000V 防火墙作为边界网关。

---

## 一、 环境准备 (手把手搭拓扑)

### 1. 拖动设备
*   **防火墙 (Firewall)**：在左侧列表找 **USG6000V**，拖入 1 台，重命名为 `FW1`。
    *   *注意*：eNSP 启动防火墙可能需要导入镜像包（vfw_usg.vdi），请确保模拟器环境正常。
*   **云 (Cloud)**：为了让 PC 能 Ping 通防火墙，或者直接用路由器模拟 PC 也行。这里我们用 **Router (AR2220)** 模拟 PC 和 Server，这样更稳定。
    *   拖入 AR2220，命名为 `PC1_Sim` (模拟内网)。
    *   拖入 AR2220，命名为 `Server_Sim` (模拟外网)。

### 2. 物理连线
*   **PC1_Sim** 的 `GE 0/0/0` 连 **FW1** 的 `GE 1/0/1` (Trust口)。
*   **Server_Sim** 的 `GE 0/0/0` 连 **FW1** 的 `GE 1/0/2` (Untrust口)。

### 3. 初始化配置 (模拟PC)
因为用路由器模拟 PC，所以要配 IP 并指网关：
*   **PC1_Sim**:
    ```shell
    [PC1] interface g0/0/0
    [PC1-g0/0/0] ip address 192.168.1.10 24
    [PC1] ip route-static 0.0.0.0 0 192.168.1.1 (网关指向防火墙)
    ```
*   **Server_Sim**:
    ```shell
    [Server] interface g0/0/0
    [Server-g0/0/0] ip address 202.100.1.2 24
    [Server] ip route-static 0.0.0.0 0 202.100.1.1 (网关指向防火墙)
    ```

### 4. 防火墙登录
*   启动 FW1，右键 CLI。
*   默认账号：`admin`
*   默认密码：`Admin@123`
*   第一次登录会强制要求改密码，请输入新密码（如 `Admin@123456`）。

---

## 二、 基础配置 (划地盘)

### 1. 配置接口 IP 并开启 Ping 服务 (重要!)
> **避坑**：华为 USG6000V 默认禁止 Ping 接口本身。如果不开启 `service-manage`，你连网关都 Ping 不通。
```shell
[FW1] interface g1/0/1
[FW1-GigabitEthernet1/0/1] ip address 192.168.1.1 24
[FW1-GigabitEthernet1/0/1] service-manage ping permit
# 大白话：允许大家 Ping 这个接口（主要用于测试连通性）。
[FW1-GigabitEthernet1/0/1] quit

[FW1] interface g1/0/2
[FW1-GigabitEthernet1/0/2] ip address 202.100.1.1 24
[FW1-GigabitEthernet1/0/2] service-manage ping permit
[FW1-GigabitEthernet1/0/2] quit
```

### 2. 将接口加入安全区域 (Zone)
```shell
[FW1] firewall zone trust
[FW1-zone-trust] add interface g1/0/1
# 大白话：G1/0/1 接口后面连接的是“自己人”，加入 Trust 区域。
[FW1-zone-trust] quit

[FW1] firewall zone untrust
[FW1-zone-untrust] add interface g1/0/2
# 大白话：G1/0/2 接口后面是“外人”，加入 Untrust 区域。
[FW1-zone-untrust] quit
```

---

## 三、 安全策略 (发通行证)

### 1. 配置策略：允许 Trust 访问 Untrust
```shell
[FW1] security-policy
[FW1-policy-security] rule name trust_to_untrust
# 大白话：新建一条规则，名字叫“允许内网出外网”。
[FW1-policy-security-rule-trust_to_untrust] source-zone trust
# 大白话：来源是 Trust 区域。
[FW1-policy-security-rule-trust_to_untrust] destination-zone untrust
# 大白话：目的地是 Untrust 区域。
[FW1-policy-security-rule-trust_to_untrust] action permit
# 大白话：动作是“放行” (Permit)。
[FW1-policy-security-rule-trust_to_untrust] quit
```

### 2. 状态检测防火墙原理 (必读)
*   **回包为什么不用配策略？**：华为防火墙是“状态检测防火墙”。只要去程流量（Trust -> Untrust）被允许并通过了，防火墙会建立一张**会话表**。回程流量（Untrust -> Trust）回来时，防火墙一查表，发现是“老熟人”的回信，就直接放行了，不需要再单独配 Untrust -> Trust 的策略。

---

## 四、 验证

*   在 PC1_Sim 上 `ping 202.100.1.2`。
*   **通了**。
*   在 Server_Sim 上 `ping 192.168.1.10`。
*   **不通**。因为没有配 Untrust -> Trust 的放行策略，且这不是回包，是主动发起的“陌生人”访问。

### 3. 专业命令验证
*   **查看会话表 (Session Table)**：
    *   在 PC1 持续 Ping Server 的时候 (`ping -c 1000 202.100.1.2`)，在防火墙上输入：
    ```shell
    [FW1] display firewall session table
    ```
    *   **结果解读**：
        ```text
        icmp  VPN: public --> public  192.168.1.10:1 --> 202.100.1.2:2048
        ```
        *   `icmp`：协议类型。
        *   `192.168.1.10 --> 202.100.1.2`：说明流量方向正确。
        *   如果你能看到这条记录，说明**状态检测机制**正在工作。

---

## 五、 保存配置 (必做!)

**防火墙保存**：
```shell
<FW1> save
```
**路由器模拟器保存**：
```shell
<PC1_Sim> save
<Server_Sim> save
```