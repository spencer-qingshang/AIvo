# 项目2：运用交换机构建小型园区网络 (新手实战版)

## 一、 项目背景：为一家初创公司组网
假设你现在是公司的网管。公司有两层楼，两个部门：**财务部**（比较机密）和**技术部**（比较开放）。
*   **需求1**：所有人的电脑都能连上公司网络。
*   **需求2**：为了安全，**财务部的电脑不能让技术部的人访问**（网络隔离）。
*   **需求3**：虽然财务部分布在两层楼，但他们之间必须能互相访问（跨楼层互通）。

为了实现这些需求，我们需要使用**交换机 (Switch)** 和 **VLAN (虚拟局域网)** 技术。

---

## 二、 环境准备与规划 (关键!)

### 1. 物理拓扑
*   **交换机**: S5700 或 S3700 (SW1, SW2)
*   **PC**: 4台 (PC1, PC2, PC3, PC4)

### 2. IP地址与VLAN规划表
**请先按照下表配置好你的PC，这是实验成功的前提！**

| 设备 | 接口/位置 | 所属VLAN | IP地址 | 子网掩码 | 默认网关 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **PC1** | 接 SW1 1号口 | VLAN 10 (财务) | 192.168.10.1 | 255.255.255.0 | 192.168.10.254 |
| **PC2** | 接 SW1 3号口 | VLAN 20 (技术) | 192.168.20.1 | 255.255.255.0 | 192.168.20.254 |
| **PC3** | 接 SW2 1号口 | VLAN 10 (财务) | 192.168.10.2 | 255.255.255.0 | 192.168.10.254 |
| **PC4** | 接 SW2 3号口 | VLAN 20 (技术) | 192.168.20.2 | 255.255.255.0 | 192.168.20.254 |
| **SW1** | Vlanif 10/20 | - | .254 (网关) | 24 | - |

---

## 三、 核心概念：VLAN (虚拟局域网)
> **通俗解释**：
> 默认情况下，插在同一个交换机上的所有电脑都能互相说话，这就像大家都在一个没有任何隔断的大通铺办公。
> **VLAN** 就像是在大通铺里起了几堵**玻璃墙**，把不同部门的人隔开。
> *   VLAN 10：财务部的专属房间。
> *   VLAN 20：技术部的专属房间。
> *   虽然大家物理上还插在同一台交换机上，但VLAN 10的人发出的消息，VLAN 20的人根本听不到。

---

## 四、 任务实战详解

### 任务1：划分部门 (创建VLAN与接口划入)
**场景**：在一台交换机上，把第1-2号口分给财务部，第3-4号口分给技术部。

#### 1. 创建VLAN (建房间)
首先要在交换机里把“房间”建好。
```shell
<Huawei> system-view
[Huawei] sysname SW1              # 改名 SW1
[SW1] vlan 10                     # 创建VLAN 10 (财务部)
[SW1-vlan10] description CaiWu    # (可选) 写个备注，防止以后忘了这是干嘛的
[SW1-vlan10] quit
[SW1] vlan 20                     # 创建VLAN 20 (技术部)
[SW1-vlan20] quit
```

#### 2. 配置接口类型 (Access)
> **Access接口**：连接普通电脑的接口。这种接口**只能属于一个VLAN**。
> *比喻*：这是通往某个特定房间的**专属房门**，进去了就是那个房间的人。

将接口加入VLAN：
```shell
[SW1] interface GigabitEthernet 0/0/1
[SW1-GigabitEthernet0/0/1] port link-type access    # 设置端口模式为 Access (接入模式)
[SW1-GigabitEthernet0/0/1] port default vlan 10     # 把这个口划分进 VLAN 10
[SW1-GigabitEthernet0/0/1] quit

# 同样的操作配置接口2 (也是财务)
[SW1] interface GigabitEthernet 0/0/2
[SW1-GigabitEthernet0/0/2] port link-type access
[SW1-GigabitEthernet0/0/2] port default vlan 10
[SW1-GigabitEthernet0/0/2] quit

# 配置接口3 (技术部)
[SW1] interface GigabitEthernet 0/0/3
[SW1-GigabitEthernet0/0/3] port link-type access
[SW1-GigabitEthernet0/0/3] port default vlan 20     # 注意这里是 VLAN 20
[SW1-GigabitEthernet0/0/3] quit
```
**新手小技巧**：如果端口很多，可以用 `port-group` 批量配置，但现在先不学那个，老老实实一个个敲能加深印象。

---

### 任务2：跨楼层连接 (Trunk接口)
**场景**：一楼交换机 (SW1) 和二楼交换机 (SW2) 之间需要拉一根网线连接。
*   **问题**：如果这根线只属于VLAN 10，那VLAN 20的数据就过不去。
*   **解决**：我们需要一条**公共通道**，允许多个VLAN的数据同时通过。这就是 **Trunk**。

> **Trunk接口**：连接交换机与交换机的接口。
> *   **打标签 (Tag)**：当数据通过Trunk时，交换机会给数据贴个标签（比如“这是VLAN 10的包裹”），这样对面的交换机收到后，就知道该把包裹送给VLAN 10的房间。

#### 配置SW1与SW2相连的接口 (假设是 GE0/0/24)
```shell
[SW1] interface GigabitEthernet 0/0/24
[SW1-GigabitEthernet0/0/24] port link-type trunk             # 设置模式为 Trunk (干道模式)
[SW1-GigabitEthernet0/0/24] port trunk allow-pass vlan 10 20 # 允许 VLAN 10 和 20 通过
# 这一步非常重要！默认Trunk只允许VLAN 1通过。
# 也可以写: port trunk allow-pass vlan all (允许所有，省事但不够安全)
```
*(注意：对面的交换机 SW2 的对应接口也要做完全一样的配置！)*

---

### 任务3：三层交换 (让不同部门也能互通)
**场景**：老板说，虽然平时要隔离，但偶尔财务部要给技术部发工资条，所以他们得能通。
*   **难点**：二层交换机只能在VLAN内部转发，跨VLAN必须找“领导”（路由器或三层交换机）。
*   **VLANIF接口**：这是三层交换机里的**虚拟路由器接口**。

#### 配置VLANIF (虚拟网关)
我们在核心交换机上配置：
```shell
[SW1] interface vlanif 10           # 进入 VLAN 10 的虚拟接口
[SW1-Vlanif10] ip address 192.168.10.254 24   # 给它配个IP，这将是财务部电脑的“默认网关”
[SW1-Vlanif10] quit

[SW1] interface vlanif 20
[SW1-Vlanif20] ip address 192.168.20.254 24   # 技术部电脑的“默认网关”
[SW1-Vlanif20] quit
```
**原理**：
1.  财务部电脑 (192.168.10.1) 想找技术部 (192.168.20.1)。
2.  发现不在同一个网段，于是把数据包发给网关 (192.168.10.254)。
3.  交换机收到后，发现要去 20.1，而且自己也有 Vlanif 20 (192.168.20.254)，于是帮忙转发过去。

---

## 五、 进阶概念速览 (了解即可)

### 1. 链路聚合 (Eth-Trunk)
*   **问题**：两个交换机之间只连一根线，万一断了怎么办？或者人太多带宽不够怎么办？
*   **解决**：连两根线！然后把这两根线在逻辑上**捆绑成一根**。
*   **好处**：速度翻倍，还有备份（断了一根还能用）。

### 2. 生成树协议 (STP)
*   **危险动作**：如果你把三台交换机连成一个**三角形**（环路）。
*   **后果**：广播风暴！数据包会在环路里无限转圈，瞬间把网络堵死，所有灯狂闪，网络瘫痪。
*   **STP的作用**：它会自动把环路中的某一条线“逻辑断开”（Blocked），平时不用，等主线路断了它再自动接通。华为交换机**默认开启** STP，新手一般不用管。

### 3. DHCP (自动发IP)
*   **现状**：目前我们需要在每台PC上手动填IP地址，好累。
*   **DHCP**：让交换机自动给插上来的电脑分配IP。

---

## 六、 验证与保存 (大功告成)

### 1. 连通性测试 (Ping)
*   **同部门互通**：PC1 Ping PC3 -> **通** (192.168.10.1 -> 192.168.10.2)。
*   **跨部门互通**：PC1 Ping PC2 -> **通** (192.168.10.1 -> 192.168.20.1)。
    *   *说明*：这需要任务3配置好VLANIF才行。如果只做完任务2，是不通的。

### 2. 保存配置
```shell
<SW1> save
<SW2> save
```

---

## 七、 新手避坑与命令速查表

| 场景 | 关键命令 | 解释 |
| :--- | :--- | :--- |
| **查VLAN** | `display vlan` | 查看建了哪些VLAN，哪些口在里面 |
| **查接口** | `display port vlan` | **最常用！** 查看接口是Access还是Trunk，以及允许了哪些VLAN |
| **配错口了** | `undo port default vlan` | 命令前加 `undo` 就是取消配置 |
| **恢复出厂** | `reset saved-configuration` | 清空所有配置，重启后生效 |

### 常见错误
1.  **Access配成了Trunk**：
    *   现象：电脑连上去不通。
    *   解决：先 `undo port link-type` 恢复默认，再重新配。
2.  **Trunk忘记放行VLAN**：
    *   现象：两个交换机下的同部门电脑不通。
    *   检查：`display port vlan` 看 Trunk 口的 `Link Type` 和 `PVID` 以及 `Trunk VLAN List`。
3.  **忘记配网关**：
    *   现象：PC可以Ping通同VLAN的人，Ping不通其他VLAN。
    *   解决：检查PC设置里的“默认网关”填没填，以及交换机的 `interface vlanif` 配没配。
