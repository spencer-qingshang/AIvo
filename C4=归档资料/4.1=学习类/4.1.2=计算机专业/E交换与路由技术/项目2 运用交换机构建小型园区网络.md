# 项目2 运用交换机构建小型园区网络 (大纲百科全书版)

> **学习指南**：本笔记为增量式构建，严禁删减。
> **目标**：覆盖 13833 大纲所有知识点，确保面对任何试卷（选择、填空、简答、应用）均有据可查。

---

## 一、 VLAN 技术 (Virtual Local Area Network)

### 1.1 VLAN 产生的背景与核心价值
*   **【硬核概念】**：二层交换机属于单一广播域。VLAN 通过在数据链路层插入标识符，将物理局域网划分为多个逻辑广播域。其核心价值在于隔离广播风暴、增强安全性、优化资源分配。
*   **【大白话解释】**：就像在一个巨大的仓库里（物理网络）砌了几堵隐形的墙（VLAN）。财务的人说话，只有财务的人能听见，老板不用担心财务数据被保洁听到（安全性），也不会因为人太多导致仓库里吵得听不见声音（防广播风暴）。

### 1.2 802.1Q 帧格式（数据包的“身份证”）
*   **【硬核概念】**：IEEE 802.1Q 标准规定在源 MAC 和 Type 之间插入 **4 字节 (32bit)** 的 Tag。
    *   **TPID (2字节)**：`0x8100`。标识它是携带标签的帧。
    *   **PRI (3位)**：优先级。范围 0-7，值越大优先级越高，用于 QoS。
    *   **CFI/DEI (1位)**：标准格式指示。在以太网中通常为 0。
    *   **VID (12位)**：VLAN ID。
*   **【大白话解释】**：原本的数据包是“裸奔”的，VLAN 就像给每个数据包发了个“胸牌”。胸牌上最重要的就是 VID（你在哪个组）。
*   **【考试细节点】**：
    *   VLAN ID 数量：$2^{12} = 4096$ 个。
    *   可用范围：1-4094。
    *   **VLAN 0**：用于识别优先级，不带 VID。
    *   **VLAN 4095**：保留，不可见。

### 1.3 划分 VLAN 的五种方式 (识记/填空)
1.  **基于端口** (Port-based)：最常用。将交换机物理口固定分给某个 VLAN。
2.  **基于 MAC 地址**：根据电脑网卡的 MAC 划分。电脑换了插口，VLAN 也不变。
3.  **基于子网**：根据 IP 地址段划分。
4.  **基于协议**：根据数据包的协议类型（IPv4/IPv6）划分。
5.  **基于策略**：最复杂，根据多种条件的组合划分。

---

## 二、 华为交换机接口逻辑 (Access/Trunk/Hybrid)

### 2.1 核心术语：PVID
*   **【硬核概念】**：Port Default VLAN ID。接口的缺省 VLAN。当接口收到不带标签的帧时，会认为是属于该 PVID 的。
*   **【大白话解释】**：这是接口的“底色”。如果进来的包没带胸牌，保安就根据门口的底色现场给它贴一个。

### 2.2 接口处理逻辑（必考简答题/应用题核心）

| 接口类型 | 接收规则 (Inbound) | 发送规则 (Outbound) |
| :--- | :--- | :--- |
| **Access** (连电脑) | 1. 无标签：打上 PVID 标签接收。<br>2. 有标签：若标签=PVID则收，不等则丢弃。 | **剥离标签**，发送原始数据帧。（电脑不认识标签） |
| **Trunk** (连交换机) | 1. 无标签：打上 PVID，检查是否在 Allow 列表。<br>2. 有标签：检查是否在 Allow 列表，在则收。 | 1. 标签在 Allow 列表且 **!= PVID**：**带标签**转发。<br>2. 标签在 Allow 列表且 **== PVID**：**剥离标签**转发。 |
| **Hybrid** (全能) | 同 Trunk 逻辑。 | **高度灵活**：可以手动配置 `port hybrid untagged vlan ...`（剥离发）或 `port hybrid tagged vlan ...`（带标发）。 |

*   **【大白话解释】**：
    *   **Access**：就像公司内部门的小门。进去贴标签，出来必须撕掉，因为员工（电脑）不习惯身上贴个条子。
    *   **Trunk**：就像两座办公大楼之间的封闭走廊。包包都带着胸牌跑。但有个特殊规定：如果胸牌刚好是默认的（比如 1），为了兼容老设备，出走廊时也会撕掉。

---

## 三、 STP/RSTP 环路保护 (防止网络“瘫痪”)

### 3.1 环路的危害
*   **【硬核概念】**：广播风暴、MAC 地址表震荡、重复帧。
*   **【大白话解释】**：网络里的数据在转圈圈。1 个包变 2 个，2 个变 4 个，不到 1 秒钟，交换机就因为处理太累而“中暑”罢工了。

### 3.2 STP 选举详解 (802.1D)
1.  **选根桥 (Root Bridge)**：比 **桥ID (Priority + MAC)**。**越小越优**。
    *   *优先级默认值*：32768。
2.  **选根端口 (RP)**：每个非根桥选 1 个。
    *   顺序：RPC (路径开销) -> 对端 BID -> 对端 PID -> 本端 PID。
3.  **选指定端口 (DP)**：每条链路选 1 个。
4.  **选阻塞端口 (AP)**：剩下的。

### 3.3 STP 的状态机与计时器 (填空重点)
*   **五种状态**：
    1.  **Disabled**：接口关了。
    2.  **Blocking**：不转数据，只听 BPDU（防环的关键）。
    3.  **Listening**：选老大阶段。
    4.  **Learning**：偷偷记下谁在哪（学 MAC 地址），但不传话。
    5.  **Forwarding**：正常工作。
*   **三个时间**：
    *   **Hello Time**：2 秒（发 BPDU 的频率）。
    *   **Max Age**：20 秒（老大哥没说话，忍多久宣布它挂了）。
    *   **Forward Delay**：15 秒（状态切换的缓冲期，防止瞬间变道撞车）。

### 3.4 RSTP (802.1W) 为什么快？
*   **【硬核概念】**：状态合并为 Discarding, Learning, Forwarding。引入 **P/A (Proposal/Agreement)** 机制实现握手快速收敛。
*   **边缘端口 (Edge Port)**：
    *   **大白话**：专门给 PC 用的。PC 不会制造环路，所以不用等那 30 秒，插上就通。

---

## 四、 链路聚合 Eth-Trunk

### 4.1 核心价值
*   增加带宽、提高可靠性、负载分担。

### 4.2 LACP 模式 (802.3ad)
*   **【硬核概念】**：不仅能并联，还能“检测”。如果一根线断了，或者光纤只能发不能收，LACP 能发现并切断它。
*   **选举依据**：系统优先级。默认 **32768**。

---

## 五、 三层交换与 VLAN 间路由

### 5.1 三层交换原理
*   **【硬核概念】**：**一次路由，多次交换**。首包由 CPU 处理并生成快捷转发项，后续包通过硬件直接转发。
*   **VLANIF 接口**：一种逻辑接口。配置 IP 后，就是该 VLAN 的**网关**。

---

## 六、 VRRP 网关冗余 (双保险)

### 6.1 基本原理
*   **【硬核概念】**：将多台网关设备虚拟成一台。对外只提供一个 **虚拟IP (VIP)**。
*   **【大白话解释】**：家里有两个路由器，我不用在手机上改设置。VRRP 就像给两个路由器罩了一个“假面具”。手机只认这个假面具的 IP，谁在面具后面干活不重要。老大挂了，老二戴上面具继续干。

---

## 七、 DHCP 动态配置 (懒人福音)

### 7.1 工作过程 (DORA 过程)
1.  **Discover** (广播)：电脑喊：“我需要 IP！”
2.  **Offer** (单播/广播)：服务器说：“我这有 1.1，你要吗？”
3.  **Request** (广播)：电脑喊：“那我就要 1.1 了，大家都别抢！”
4.  **Ack** (单播/广播)：服务器说：“行，归你了，租期 8 天。”

---

## 🛠️ 实验命令备忘录 (带解析)

1.  **配置 Hybrid 接口 (常见难题)**：
    ```shell
    # 让接口属于 VLAN 10，且发出去时剥掉标签
    port link-type hybrid
    port hybrid pvid vlan 10
    port hybrid untagged vlan 10
    ```
2.  **查看 STP 状态**：
    ```shell
    display stp brief    # 看哪个口是 Forwarding，哪个是 Discarding
    ```
3.  **配置 Eth-Trunk 强制放行 VLAN**：
    ```shell
    interface eth-trunk 1
     port link-type trunk
     port trunk allow-pass vlan all
    ```
