# 项目2 运用交换机构建小型园区网络 (理论+实操全能版)

## 0. 考试大纲要求
*   **识记**：VLAN概念、划分方式；VLAN帧格式；链路类型(Access/Trunk)；三层交换机概念；STP/RSTP基本概念；链路聚合概念。
*   **领会**：VLAN转发缺陷与改进；VLAN跨交换机通信原理；三层交换机工作原理；STP/RSTP工作过程；VRRP原理；DHCP工作过程。
*   **应用**：VLAN划分配置；Access/Trunk/Hybrid端口配置；VLANIF三层配置；链路聚合配置；STP/RSTP配置；VRRP/DHCP配置。

---

## 一、 VLAN 技术 (核心考点)

### 1. 为什么要划分 VLAN？ (简答题必备)
1.  **隔离广播域**：防止广播风暴浪费带宽。
2.  **安全性**：不同 VLAN 之间默认不能通信，保护敏感数据。
3.  **灵活管理**：逻辑划分不受物理位置限制（比如1楼和3楼的电脑可以属于同一个 VLAN）。

### 2. VLAN 帧格式 (识记/填空)
*   **标准协议**：**IEEE 802.1Q**。
*   **实现方式**：在以太网帧的“源MAC”和“类型”字段之间插入 **4个字节** 的 **Tag**。
*   **VLAN ID 范围**：12位(Bit)二进制表示，范围 **0~4095**。
    *   **0 和 4095**：系统保留，不可用。
    *   **1**：默认 VLAN。
    *   **1~4094**：用户可创建和使用的范围。

### 3. 链路类型与接口处理规则 (领会/应用 - 重点！)
华为交换机有三种接口类型：

| 接口类型 | PVID (缺省VLAN) | 入方向(接收)处理 | 出方向(发送)处理 | 典型用途 |
| :--- | :--- | :--- | :--- | :--- |
| **Access** | 必须有 | 强制打上接口 PVID 标签 | **剥离**标签，发原始帧 | 连 PC、服务器 |
| **Trunk** | 默认 1 | 在允许列表则透传；不带标签则打上 PVID | 标签在允许列表则**带标签**转发；若标签=PVID则**剥离** | 连交换机、路由器 |
| **Hybrid** | 灵活 | 类似 Trunk，可手动决定是否带标签 | 可以根据配置**手动决定**是否剥离标签 | 灵活连接各类设备 |

---

## 二、 STP 生成树协议 (理论难点)

### 1. 产生背景
由于网络冗余（接了两根线防止断网），会导致**物理环路**。环路会引发：
1.  **广播风暴**（数据帧无限循环）。
2.  **MAC地址表震荡**。

### 2. STP 的作用
通过逻辑上**阻塞(Blocking)**某个端口，把环路变成**树状结构**。当活动链路断开时，阻塞端口会自动开启。

### 3. STP 选举四步走 (简答/填空)
1.  **选根桥 (Root Bridge)**：比 **桥ID (BID)**。BID=优先级+MAC地址。**越小越优**。
2.  **选根端口 (RP)**：非根桥设备上距离根桥“最近”的端口。
3.  **选指定端口 (DP)**：每条链路上距离根桥“最近”的端口。
4.  **阻塞端口 (AP)**：剩下的全阻塞。

### 4. 关键参数 (填空)
*   **默认优先级**：**32768**。
*   **BPDU (桥协议数据单元)**：STP 交互的控制报文。
*   **收敛时间**：普通 STP 从阻塞到转发需要约 **30秒**。

---

## 三、 三层交换与链路聚合

### 1. 三层交换机 (L3 Switch)
*   **原理**：**“一次路由，多次交换”**。
*   **核心组件**：**VLANIF 接口**（一种虚拟的三层接口，配置 IP 作为该 VLAN 电脑的网关）。
*   **区别**：路由器侧重广域网接入；三层交换机侧重局域网内的高速转发（硬件转发）。

### 2. 链路聚合 (Eth-Trunk)
*   **作用**：增加带宽、提高可靠性、负载分担。
*   **模式**：
    1.  **Manual (手动)**：所有活动链路均参与转发。
    2.  **LACP (动态)**：通过 LACP 协议协商，可区分活动链路和备份链路。

---

## 四、 项目实操：核心命令集 (应用)

### 1. VLAN 基础配置
```shell
[Huawei] vlan 10                  # 创建单 VLAN
[Huawei] vlan batch 10 20 30      # 批量创建
[Huawei-GigabitEthernet0/0/1] port link-type access
[Huawei-GigabitEthernet0/0/1] port default vlan 10
[Huawei-GigabitEthernet0/0/24] port link-type trunk
[Huawei-GigabitEthernet0/0/24] port trunk allow-pass vlan all
```

### 2. 三层 VLANIF 配置 (VLAN 间通信)
```shell
[Huawei] interface vlanif 10
[Huawei-Vlanif10] ip address 192.168.10.1 24
```

### 3. 链路聚合配置
```shell
[Huawei] interface eth-trunk 1
[Huawei-Eth-Trunk1] trunkport gigabitethernet 0/0/1 to 0/0/2
[Huawei-Eth-Trunk1] port link-type trunk
[Huawei-Eth-Trunk1] port trunk allow-pass vlan all
```

### 4. STP 基础配置
```shell
[Huawei] stp mode rstp             # 华为默认常用 RSTP
[Huawei] stp root primary          # 强制将本交换机设为根桥
[Huawei-GigabitEthernet0/0/1] stp edged-port enable  # 设置为边缘端口
```

---

## 五、 考试易错点速查
1.  VLAN 划分方法中，最常用的是**基于端口**的划分。
2.  Access 口发出的是**不带标签**的帧，Trunk 口发出的通常是**带标签**的帧。
3.  STP 选举中，BID 的优先级必须是 **4096 的倍数**。
4.  三层交换机转发数据靠的是 **硬件** 查找 MAC 表和路由表，速度远快于普通路由器。
