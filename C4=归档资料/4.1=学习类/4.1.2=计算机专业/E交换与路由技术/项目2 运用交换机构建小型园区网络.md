# 项目2 运用交换机构建小型园区网络 (大纲全覆盖深度知识库)

> **版本说明**：本笔记严格遵循课程代码 13833 考试大纲。
> **学习目标**：彻底掌握局域网交换技术的核心原理，建立完整的二层/三层转发知识体系。

---

## 第一章：VLAN 虚拟局域网技术 (VLAN Technology)

### 1.1 VLAN 的基本概念与产生背景 (识记)
*   **传统局域网的问题**：在一个物理网段内，所有的主机都属于同一个**广播域**。随着主机增多，广播风暴加剧，网络安全性和管理灵活性极低。
*   **VLAN 的定义**：将一个物理局域网在逻辑上划分成多个广播域的技术。
*   **VLAN 的优势**：
    1.  **限制广播域**：广播报文被限制在所属 VLAN 内。
    2.  **增强安全性**：不同 VLAN 间二层隔离，无法直接互访。
    3.  **灵活分组**：基于业务或部门划分，不受地理位置限制。

### 1.2 802.1Q 帧格式深度解析 (填空/领会)
*   **标准**：IEEE 802.1Q (又称 Dot1Q)。
*   **插入位置**：源 MAC 地址与协议类型 (Type) 字段之间。
*   **结构 (共 4 字节/32位)**：
    1.  **TPID (Tag Protocol Identifier)**：2 字节，固定值为 `0x8100`，标识该帧携带 802.1Q 标签。
    2.  **TCI (Tag Control Information)**：2 字节，具体包含：
        *   **Priority (PRI)**：3 位，表示 802.1p 优先级 (0-7)，用于 QoS 服务质量。
        *   **CFI (Canonical Format Indicator)**：1 位，标识 MAC 地址格式。
        *   **VLAN ID (VID)**：**12 位**，决定了 VLAN 的取值范围。
*   **VLAN ID 取值**：
    *   数学范围：$2^{12} = 4096$ 个地址 (0 - 4095)。
    *   **可用范围**：1 - 4094。
    *   **保留值**：0 和 4095 协议保留，用户无法配置。

### 1.3 华为交换机接口类型与转发行为 (核心领会/应用)
这是交换技术最底层的逻辑，必须掌握 **PVID (Port VLAN ID)** 和 **Tag 列表** 的判断机制。

#### (1) Access 接口 (接入链路)
*   **特点**：只能属于 1 个 VLAN，通常连接用户终端 (PC、服务器、打印机)。
*   **接收规则**：
    *   收到不带 Tag 的帧：打上接口的 PVID。
    *   收到带 Tag 的帧：若 Tag 等于 PVID 则接收，不等则丢弃。
*   **发送规则**：**剥离 Tag** 后发送。

#### (2) Trunk 接口 (干道链路)
*   **特点**：允许多个 VLAN 通行，通常连接交换机或路由器。
*   **接收规则**：
    *   收到不带 Tag 的帧：打上接口 PVID，并检查 PVID 是否在 `allow-pass` 列表中。
    *   收到带 Tag 的帧：检查 VID 是否在 `allow-pass` 列表中，在则接收。
*   **发送规则**：
    *   若 VID = PVID 且在允许列表中：**剥离 Tag** 发送 (为了与对端 PVID 匹配)。
    *   若 VID != PVID 且在允许列表中：**携带 Tag** 发送。

#### (3) Hybrid 接口 (华为特色)
*   **特点**：华为默认模式。既可以连接用户，也可以连接交换机。
*   **核心逻辑**：通过 `untagged` 和 `tagged` 两个列表，手动决定在发送时是否剥离标签。

---

## 第二章：STP 与 RSTP 生成树协议 (Redundancy & Loop Prevention)

### 2.1 环路的产生与危害 (领会)
*   **产生**：为了提高可靠性，网络中存在物理备份链路。
*   **危害**：
    1.  **广播风暴**：数据帧无限循环转发。
    2.  **MAC 地址表漂移/震荡**：交换机不停更新 MAC 地址与端口的映射。
    3.  **多帧复制**：同一报文多次发送到目的地。

### 2.2 STP (802.1D) 选举机制 (权威简答题流程)
1.  **选根桥 (Root Bridge)**：比较 **桥 ID (BID = 优先级 + MAC)**。**数值最小者**胜出。
    *   *注*：优先级默认 32768，修改时必须是 4096 的倍数。
2.  **选根端口 (Root Port, RP)**：
    *   在每个非根桥上选出一个。依据顺序：RPC (路径开销) -> 对端 BID -> 对端 PID (端口ID) -> 本端 PID。
3.  **选指定端口 (Designated Port, DP)**：
    *   在每条物理链路上选出一个。依据同上。根桥的所有接口通常都是 DP。
4.  **选阻塞端口 (Alternate Port, AP)**：
    *   剩余端口逻辑阻塞，不转发流量，但**接收 BPDU**。

### 2.3 STP 端口状态机 (识记)
*   **Disabled**：关闭。
*   **Blocking**：不学习 MAC，不转发，收 BPDU。
*   **Listening**：选举阶段，不转发，不学习 MAC。
*   **Learning**：学习 MAC，不转发数据（为了防止初始泛洪）。
*   **Forwarding**：完全正常工作。

### 2.4 RSTP (802.1W) 的改进点 (领会)
*   **收敛速度**：从秒级降至毫秒级。
*   **边缘端口 (Edge Port)**：配置在连接终端的端口。插线后直接进入 Forwarding 状态，不参与计算。
*   **P/A 机制**：通过“请求/同意”报文，实现同步握手，快速进入转发。

---

## 第三章：链路聚合 Eth-Trunk (Link Aggregation)

### 3.1 核心价值 (识记)
1.  **增加带宽**：聚合多条物理链路。
2.  **提高可靠性**：部分链路故障时，业务不中断。
3.  **负载分担**：在不同链路上平衡流量。

### 3.2 两种模式对比 (领会)
*   **手工模式 (Manual)**：简单，但无法检测对端故障（如光纤单通）。
*   **LACP 模式 (802.3ad)**：
    *   主动端选举：比较系统优先级。
    *   活动链路选举：根据端口优先级选出活动的 M 条链路，其余 N 条备份。

---

## 第四章：VLAN 间通信与三层交换技术

### 4.1 单臂路由 vs 三层交换 (领会)
*   **单臂路由 (Router-on-a-stick)**：利用路由器的**子接口 (Sub-interface)** 终结 VLAN 标签。
*   **三层交换 (L3 Switching)**：使用 **VLANIF** 逻辑接口作为网关。

### 4.2 三层转发原理 (核心应用)
*   **“一次路由，多次交换”**：首包触发 CPU 路由，后续流通过硬件转发。
*   **VLANIF 接口**：三层交换机内部配置的虚拟三层接口，状态取决于该 VLAN 内是否有物理接口 Up。

---

## 第五章：高可用性与基础服务 (VRRP & DHCP)

### 5.1 VRRP (虚拟路由冗余协议) 深度精讲 (领会/应用)
*   **目的**：解决单网关故障导致的单点失效问题。
*   **术语**：
    *   **VRID**：虚拟路由器 ID (0-255)。
    *   **VIP (Virtual IP)**：对外提供的统一网关 IP。
    *   **VMAC (Virtual MAC)**：`00-00-5E-00-01-{VRID}`。
*   **选举机制**：
    *   优先级范围 0-255。
    *   **默认 100**。
    *   优先级最高者为 **Master**，其余为 **Backup**。
    *   *抢占模式*：Master 恢复后可重新夺回主权。

### 5.2 DHCP (动态主机配置协议) 工作过程 (领会)
*   **核心四步交互 (DORA)**：
    1.  **Discover** (广播)：Client 寻找 Server。
    2.  **Offer** (单播/广播)：Server 提供预分配 IP。
    3.  **Request** (广播)：Client 确认选择。
    4.  **Ack** (单播/广播)：Server 确认租约生效。

---

## 💡 考试必背配置模板 (应用层级)

### 1. 交换机 VLAN 初始化
```shell
# 批量创建并批量改接口
vlan batch 10 20
port-group group-member g0/0/1 to g0/0/10
 port link-type access
 port default vlan 10
```

### 2. STP 根桥优化
```shell
stp mode rstp
stp root primary      # 强制设置优先级为 0 (最高优先级)
# 或者
stp priority 4096
```

### 3. VRRP 网关高可用
```shell
interface Vlanif10
 vrrp vrid 1 virtual-ip 192.168.10.254
 vrrp vrid 1 priority 120    # 设为主
 vrrp vrid 1 preempt-mode timer delay 20 # 开启抢占并延迟
```

### 4. DHCP 全局地址池
```shell
dhcp enable
ip pool OFFICE
 network 192.168.10.0 mask 255.255.255.0
 gateway-list 192.168.10.1
 lease day 8
```
