# 项目2 运用交换机构建小型园区网络

## 一、学习目的与要求

交换机技术在现代的高速网络中起到举足轻重的作用，企业网络依赖交换机分隔网段并实现高速连接。交换机有多重级别的分类，一般可以分为二层和三层交换机。二层交换机属于数据链路层设备，可以识别数据包中的MAC地址信息，根据MAC地址进行转发，并将这些MAC地址与对应的端口记录在自己内部的一个地址表中。三层交换机的最重要的功能是加快大型局域网内部的数据的快速转发，加强了路由转发功能。

交换机应用非常广泛，在简单场景中，可以替代集线器作为多台主机的中心连接点；在复杂应用中，交换机可以连接一台或多台其他交换机，从而建立、管理和维护冗余链路及VLAN连通性。通过本章的学习与实践，达到熟悉交换机的配置、熟练进行交换机的管理与维护。

### 学习目标：
1. 能使用终端软件正确连接交换机；
2. 能熟练配置交换机的各项网络参数及端口状态；
3. 能学会交换机VLAN的划分方法；
4. 能学会配置交换机间相同VLAN的通讯的方法；
5. 能学会三层交换机实现不同VLAN间通讯的方法；
6. 能熟练配置交换机链路聚合技术；
7. 能熟练配置生成树及快速生成树；
8. 能熟练配置交换机的VRRP技术；
9. 能熟练配置交换机的DHCP技术。

## 二、交换机管理与 CLI 基础

### 1. 视图模式 (View Modes)
- **用户视图 (`<Huawei>`)**：登录后的初始模式。只能进行基础查看（`display`）和简单的调试。
- **系统视图 (`[Huawei]`)**：在用户视图下输入 `system-view` 进入。可进行全局参数配置（如修改主机名、开启服务）。
- **接口视图 (`[Huawei-GigabitEthernet0/0/1]`)**：在系统视图下进入特定接口。用于配置接口 IP、VLAN 属性等。
- **协议视图**：如 `[Huawei-ospf-1]`，用于配置特定协议参数。
- **退出命令**：`quit` 返回上一级；`return` 或 `Ctrl+Z` 直接返回用户视图。

### 2. CLI 辅助功能
- **帮助系统**：输入 `?` 可查看当前模式下所有可用命令或命令的后续参数。
- **补全功能**：按 `Tab` 键可自动补全不完整的命令。
- **简写执行**：只要命令是不唯一的，即可简写（如 `sys` 代替 `system-view`）。

### 3. 配置保存与管理
- **当前配置**：`display current-configuration`（运行在 RAM 中，重启丢失）。
- **保存配置**：`save`（保存到 Flash/SD 卡中）。
- **查看保存配置**：`display saved-configuration`。

### 4. 设备登录与安全管理
- **Console 登录**：物理连接 Console 口，无需 IP 即可管理。
- **Telnet/SSH 远程管理**：
    - 需要配置 **VTY (Virtual Type Terminal)** 虚接口。
    - **认证方式**：
        - **Password 认证**：仅输入密码即可进入。
        - **AAA 认证**：需要用户名 + 密码，安全性更高，可分配权限等级。
    - **AAA 配置核心**：
        ```bash
        aaa
         local-user admin password cipher 123456
         local-user admin service-type telnet
         local-user admin privilege level 15
        user-interface vty 0 4
         authentication-mode aaa
        ```

## 三、考核知识点与考核要求

### 1. 交换机基本配置
- **识记**：交换机管理方式；Console端口登录管理；交换机命令视图模式。
- **领会**：交换机端口类型；交换机端口双工模式；交换机端口速率。
- **应用**：交换机的基础配置。

### 2. 实现不同部门之间网络隔离
- **识记**：VLAN (Virtual Local Area Network) 即虚拟局域网。
    - **VLAN 帧格式**：在原始以太网帧中插入 4 字节的 **802.1Q Tag**。其中包含 TPID (0x8100) 和 TCI (包含 Priority, CFI, 以及 12 位的 **VLAN ID**)。VLAN ID 范围为 0~4095，可用范围为 1~4094。
    - **划分方式**：基于端口（最常用）、基于 MAC 地址、基于子网、基于协议。
- **领会**：VLAN 技术通过将物理 LAN 划分为多个逻辑广播域，有效抑制广播风暴，增强网络安全，并简化网络管理。
- **应用：VLAN 数据处理逻辑（关键考点）**
    - **PVID (Port Default VLAN ID)**：接口默认 VLAN ID。
    - **Access 端口**：
        - **接收**：若报文无 Tag，打上 PVID 接收；若有 Tag 且与 PVID 相同则接收，不同则丢弃。
        - **发送**：剥离 Tag，发送原始帧（用于连接 PC）。
    - **Trunk 端口**：
        - **接收**：若报文无 Tag，打上 PVID 接收；若有 Tag 且在允许列表中，直接接收。
        - **发送**：若 Tag 与 PVID 相同且在允许列表中，剥离 Tag 发送；若 Tag 与 PVID 不同且在允许列表中，保留 Tag 发送（用于连接交换机）。
    - **Hybrid 端口（华为默认类型）**：
        - **特点**：允许多个 VLAN 通过，并能灵活控制发送时是否带 Tag。
        - **接收逻辑**：同 Trunk。
        - **发送逻辑**：检查 `untagged` 和 `tagged` 列表。若在 `untagged` 列表，剥离 Tag 发送；若在 `tagged` 列表，保留 Tag 发送。
        - **应用场景**：混杂模式，可实现不同 VLAN 间的二层互访（如多个部门共用一台打印机）。

> [!TIP] 考试贴士：VLAN 核心考点
> - **识记**：VLAN ID 范围 1-4094。
> - **理解**：Access 发出一定是不带 Tag 的；Trunk 发出除了 PVID 外一定带 Tag。
> - **Hybrid 考点**：Hybrid 端口是华为交换机默认的接口类型。其核心在于 `port hybrid untagged vlan` 命令的使用。

### 3. 实现相同部门跨交换机互访
- **识记**：
    - **Access 端口**：仅允许单一 VLAN 通过，通常连接终端设备。
    - **Trunk 端口**：允许多个 VLAN 通过，通常连接交换机或路由器。
- **领会**：**Trunk 链路的作用**在于通过单条物理链路承载多个 VLAN 的流量，实现跨交换机同业务部门的二层互通。
- **应用：跨交换机 VLAN 工作流程**
    - 交换机 A 接收 PC 报文 -> 打上 VLAN Tag -> 从 Trunk 端口发出（保留 Tag） -> 交换机 B 接收报文（检查允许列表） -> 从对应目标端口发出（剥离 Tag） -> PC 接收。

### 4. 利用三层交换机实现部门间网络互访
- **识记**：
    - **三层交换机**：具备路由功能的交换机（一次路由，多次交换）。
    - **VLANIF 接口**：三层交换机为每个 VLAN 创建的虚接口，作为该 VLAN 的网关。
- **领会**：三层交换机通过硬件 ASIC 芯片实现高速数据转发，解决了二层交换机无法跨 VLAN 通信的问题。相比路由器，其交换容量更大。
- **应用：VLAN 间路由配置流程**
    - 创建 VLAN -> 将端口加入 VLAN -> 创建 VLANIF 接口并配置 IP 地址（网关） -> PC 设置对应网关 IP。

### 5. 提高骨干链路带宽
- **识记**：**链路聚合 (Eth-Trunk)**：将多个物理端口捆绑为一个逻辑端口。
- **领会：链路聚合的模式**
    - **手工负载分担模式**：所有链路均处于转发状态，适合对端不支持 LACP 的情况。
    - **LACP 模式**：通过协议协商，支持活动链路备份（M:N 模式）。
- **应用：优势与负载分担**
    - **优势**：提高带宽、提高链路可靠性、负载分担。
    - **负载分担方式**：基于源/目的 MAC、源/目的 IP 等（防止数据乱序）。

### 6. 避免网络环路
- **识记**：
    - **网络环路**：导致广播风暴、MAC 地址表震荡。
    - **STP (Spanning Tree Protocol)**：生成树协议，通过阻塞冗余链路消除二层环路。
    - **RSTP (Rapid STP)**：快速生成树，缩短了收敛时间（从 STP 的 30-50s 降至秒级）。
- **领会：STP 选举机制 (4 步走)**
    1. **选根桥 (Root Bridge)**：桥 ID 最小（优先级 + MAC 地址）。
    2. **选根端口 (Root Port)**：每个非根桥选一个，到根桥开销最小。
    3. **选指定端口 (Designated Port)**：每条链路选一个，用于转发 BPDU。
    4. **阻塞剩余端口**：设为 Alternate 状态。
- **领会：STP 端口状态（背诵重点）**
    - **Disabled**：接口关闭。
    - **Blocking**：只收 BPDU，不发 BPDU，不学 MAC，不转数据。
    - **Listening**：确定角色。收发 BPDU，不学 MAC，不转数据。
    - **Learning**：学习 MAC 地址。收发 BPDU，学 MAC，不转数据。
    - **Forwarding**：正常转发。收发 BPDU，学 MAC，转数据。
- **识记：BPDU (Bridge Protocol Data Unit)**
    - 交换机之间交换的报文，包含 Root ID、Cost、Bridge ID、Port ID 等关键字段。
- **应用：RSTP 的优化特性**
    - **边缘端口 (Edge Port)**：直接连接 PC，不参与选举，立即进入转发状态。
    - **PA (Proposal/Agreement) 机制**：让指定端口快速进入转发状态。

> [!TIP] 考试贴士：生成树
> - **识记**：STP 状态包括 Blocking, Listening, Learning, Forwarding, Disabled。
> - **应用**：若想固定某交换机为根桥，应将其优先级设置为最小（如 0 或 4096 的倍数）。

### 7. 提高网络稳定性
- **识记**：
    - **VRRP (Virtual Router Redundancy Protocol)**：虚拟路由冗余协议。
    - **虚拟路由器**：由 Master 和 Backup 组成，对外呈现一个虚拟 IP (VIP) 和虚拟 MAC。
- **领会：VRRP 工作过程**
    - Master 定期发送报文维持地位。若 Backup 在超时时间内未收到，则抢占为新的 Master。
    - **抢占模式 (Preempt)**：优先级高的交换机在恢复后重新成为 Master。
- **应用：Tracert 的作用**
    - 用于探测报文经过的路径，判断流量是否通过主设备转发。

> [!TIP] 考试贴士：VRRP
> - **理解**：VIP 必须与接口 IP 在同一网段。
> - **排障**：若两台设备均为 Master，通常是由于链路不通导致无法收到对方的 VRRP 报文。

### 8. 实现部门部门计算机动态获取地址
- **识记**：**DHCP (Dynamic Host Configuration Protocol)**。
- **领会：DHCP 四步交互过程**
    1. **Discover** (广播)：PC 寻找 DHCP 服务器。
    2. **Offer** (单播/广播)：服务器提供 IP 租约。
    3. **Request** (广播)：PC 确认使用该 IP。
    4. **Ack** (单播/广播)：服务器最终确认，租约生效。
- **应用：DHCP 配置重点**
    - **接口地址池 vs 全局地址池**。
    - **DHCP Relay (中继)**：当客户端与服务器不在同一网段时，由网关转发 DHCP 报文。

## 三、常用命令速查表

| 功能分类 | 命令示例 | 说明 |
| :--- | :--- | :--- |
| **基础配置** | `sysname SW1` | 修改设备名称 |
| | `display version` | 查看系统版本信息 |
| | `save` | 保存当前配置 |
| **VLAN 配置** | `vlan 10` | 创建 VLAN 10 |
| | `port link-type access` | 设置端口为 Access 模式 |
| | `port default vlan 10` | 将 Access 端口加入 VLAN 10 |
| | `port link-type trunk` | 设置端口为 Trunk 模式 |
| | `port trunk allow-pass vlan all` | 允许所有 VLAN 通过 Trunk |
| **三层通信** | `interface vlanif 10` | 创建并进入 VLANIF 10 接口 |
| | `ip address 192.168.10.1 24` | 为虚接口配置 IP 地址 |
| **链路聚合** | `interface eth-trunk 1` | 创建聚合链路组 1 |
| | `mode lacp` | 设置聚合模式为 LACP |
| | `trunkport GigabitEthernet 0/0/1` | 将物理端口加入聚合组 |
| **可靠性** | `stp mode rstp` | 设置生成树模式为 RSTP |
| | `stp root primary` | 将当前交换机设为根桥 |
| | `vrrp vrid 1 virtual-ip 192.168.1.254` | 配置虚拟网关地址 |
| **自动化** | `dhcp enable` | 开启 DHCP 服务功能 |
| | `ip pool pool1` | 创建全局地址池 |
| | `network 192.168.1.0 mask 24` | 配置地址池网段 |

## 四、本章重点、难点

**本章的重点**是要先理解二层交换机、三层交换机工作的原理，交换机所具备的功能，并理解这些功能产生的效果。熟悉与理解划分VLAN的作用，以及交换机不同端口类型对VLAN数据帧的处理过程。如何对交换机进行正确的配置，以启动交换机相关的各项功能，从而完成小型园区网络的构建。

**本章的难点**是熟悉交换机各项功能的配置命令，并对小型园区网络工程进行可靠性设计并完成配置任务。

## 六、实战演练（预留）

> [!NOTE] 提示
> 此部分用于记录该项目相关的实验拓扑图、配置命令及实验结果验证。

### 4.1 基础配置实验
- Console 登录与视图切换
- 端口速率与双工模式配置

### 4.2 VLAN 与跨交换机通信
**配置模板：**
```bash
# SW1 (Access 端口连接 PC)
vlan 10
 interface GigabitEthernet 0/0/1
  port link-type access
  port default vlan 10
# Trunk 端口连接 SW2
 interface GigabitEthernet 0/0/24
  port link-type trunk
  port trunk allow-pass vlan 10
```

### 4.3 三层交换路由
**配置模板：**
```bash
# 三层交换机配置网关
vlan batch 10 20
interface vlanif 10
 ip address 192.168.10.1 24
interface vlanif 20
 ip address 192.168.20.1 24
```

### 4.4 可靠性与自动化
**链路聚合 (LACP 模式) 模板：**
```bash
interface eth-trunk 1
 mode lacp
 interface GigabitEthernet 0/0/1
  eth-trunk 1
 interface GigabitEthernet 0/0/2
  eth-trunk 1
```

**DHCP 全局地址池模板：**
```bash
dhcp enable
ip pool VLAN10
 network 192.168.10.0 mask 255.255.255.0
 gateway-list 192.168.10.1
 dns-list 8.8.8.8
interface vlanif 10
 dhcp select global
```

## 五、常见错误分析

1. **VLAN 间不通**：
    - 检查物理链路是否 Up。
    - 检查 Trunk 端口是否允许了对应的 VLAN。
    - 检查三层交换机的 VLANIF 接口 IP 是否正确，且 PC 的网关是否指向该 IP。
2. **STP 频繁收敛**：
    - 检查链路质量。
    - 确保连接终端的端口配置了 `stp edged-port enable`。
3. **DHCP 获取不到地址**：
    - 检查 `dhcp enable` 是否开启。
    - 检查地址池范围是否包含当前网段。
    - 若跨网段，检查中继（Relay）配置。
4. **VRRP 状态异常**：
    - 检查两端虚拟 IP (VIP) 是否一致。
    - 检查 Master/Backup 的优先级配置及抢占设置。

