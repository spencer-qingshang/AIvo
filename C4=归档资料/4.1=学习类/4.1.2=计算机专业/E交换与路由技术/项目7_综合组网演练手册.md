# 项目7：中型企业园区网综合实训手册 (终极实战)

> **核心目标**：从零开始，使用 eNSP 构建一个包含接入层、核心层、无线层和安全出口的完整企业网络。实现全网互通并具备基础安全防护。
> **适用场景**：综合课程设计、期末大作业、自考综合实训。

---

## 一、 环境准备 (手把手搭拓扑)

### 1. 设备清单
*   **接入层**: 拖入 1 台 **S3700** 交换机，命名为 `LSW1`。
*   **核心层**: 拖入 1 台 **S5700** 交换机，命名为 `CoreSW`。
*   **无线层**:
    *   拖入 1 台 **AC6005**，命名为 `AC`。
    *   拖入 1 台 **AP6050**，命名为 `AP1`。
*   **出口层**: 拖入 1 台 **AR2220** 路由器，命名为 `AR1` (企业出口)。
*   **互联网**: 拖入 1 台 **AR2220** 路由器，命名为 `ISP`。
*   **终端**: 拖入 2 台 PC (`PC1`, `PC2`)，1 台 `STA` (手机/笔记本)，1 台 `Server` (百度服务器)。

### 2. 物理连线 (严格按图连)
*   **PC1** 连 **LSW1** 的 `Eth 0/0/1`。
*   **PC2** 连 **LSW1** 的 `Eth 0/0/2`。
*   **AP1** 连 **LSW1** 的 `Eth 0/0/3`。
*   **LSW1** 的 `GE 0/0/1` (上行) 连 **CoreSW** 的 `GE 0/0/1` (下行)。
*   **AC** 的 `GE 0/0/1` 连 **CoreSW** 的 `GE 0/0/2` (旁挂)。
*   **CoreSW** 的 `GE 0/0/24` (上行) 连 **AR1** 的 `GE 0/0/0` (内网口)。
*   **AR1** 的 `GE 0/0/1` (外网口) 连 **ISP** 的 `GE 0/0/0`。
*   **ISP** 的 `GE 0/0/1` 连 **Server**。

### 3. PC与服务器配置 (地基)
请在开机后，双击终端设备进行如下静态 IP 配置：
*   **PC1/PC2**: 勾选 **DHCP** (稍后由 CoreSW 分配)。
*   **Server (百度服务器)**:
    *   **IP地址**: `202.100.1.2`
    *   **子网掩码**: `255.255.255.0`
    *   **网关**: `202.100.1.1` (指向 ISP 路由器)。
*   **ISP 路由器**:
    ```shell
    [ISP] interface g0/0/0
    [ISP-g0/0/0] ip address 202.100.1.1 24
    [ISP] interface g0/0/1
    [ISP-g0/0/1] ip address 202.100.1.2 24 (模拟外网)
    ```

### 4. 规划表 (一图胜千言)
| 区域 | VLAN | IP网段 | 网关 (CoreSW) | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| **员工区** | VLAN 10 | 192.168.10.0/24 | 192.168.10.254 | 有线接入 |
| **无线区** | VLAN 20 | 192.168.20.0/24 | 192.168.20.254 | 手机接入 |
| **管理区** | VLAN 100 | 192.168.100.0/24| 192.168.100.254| AP管理 |
| **互联区** | VLAN 800 | 10.1.1.0/24 | 10.1.1.1 | 核心连出口 |
| **外网区** | - | 202.100.1.0/24 | - | 模拟互联网 |

---

## 二、 第一步：基础接入与 VLAN (打通骨架)

### 1. 接入交换机 LSW1
```shell
<Huawei> system-view
[Huawei] sysname LSW1
[LSW1] vlan batch 10 100
[LSW1] interface e0/0/1
[LSW1-Ethernet0/0/1] port link-type access
[LSW1-Ethernet0/0/1] port default vlan 10  # 连PC1
[LSW1] interface e0/0/3
[LSW1-Ethernet0/0/3] port link-type trunk
[LSW1-Ethernet0/0/3] port trunk pvid vlan 100 # 给AP管理流量打标
[LSW1-Ethernet0/0/3] port trunk allow-pass vlan 10 100 # 连AP
[LSW1] interface g0/0/1
[LSW1-GigabitEthernet0/0/1] port link-type trunk
[LSW1-GigabitEthernet0/0/1] port trunk allow-pass vlan 10 100 # 上行连核心
```

### 2. 核心交换机 CoreSW
```shell
<Huawei> system-view
[Huawei] sysname CoreSW
[CoreSW] vlan batch 10 20 100 800
# 1. 下连接入交换机
[CoreSW] interface g0/0/1
[CoreSW-GigabitEthernet0/0/1] port link-type trunk
[CoreSW-GigabitEthernet0/0/1] port trunk allow-pass vlan 10 100 
[CoreSW-GigabitEthernet0/0/1] quit

# 2. 旁挂连接 AC (关键步骤，漏了 AP 就上不了线！)
[CoreSW] interface g0/0/2
[CoreSW-GigabitEthernet0/0/2] port link-type trunk
[CoreSW-GigabitEthernet0/0/2] port trunk allow-pass vlan 100
[CoreSW-GigabitEthernet0/0/2] quit

# 3. 上连路由器
[CoreSW] interface g0/0/24
[CoreSW-GigabitEthernet0/0/24] port link-type access
[CoreSW-GigabitEthernet0/0/24] port default vlan 800
[CoreSW-GigabitEthernet0/0/24] quit
```

---

## 三、 第二步：三层网关与 DHCP (派发地址)

### 1. 配置 VLANIF 接口
```shell
[CoreSW] interface vlanif 10
[CoreSW-Vlanif10] ip address 192.168.10.254 24
[CoreSW] interface vlanif 20
[CoreSW-Vlanif20] ip address 192.168.20.254 24
[CoreSW] interface vlanif 100
[CoreSW-Vlanif100] ip address 192.168.100.254 24
[CoreSW] interface vlanif 800
[CoreSW-Vlanif800] ip address 10.1.1.1 24
```

### 2. 开启 DHCP 服务
```shell
[CoreSW] dhcp enable
[CoreSW] interface vlanif 10
[CoreSW-Vlanif10] dhcp select interface
[CoreSW] interface vlanif 20
[CoreSW-Vlanif20] dhcp select interface
[CoreSW] interface vlanif 100
[CoreSW-Vlanif100] dhcp select interface
[CoreSW-Vlanif100] dhcp server option 43 sub-option 3 ascii 192.168.100.1 # 告诉AP，AC是100.1
```

---

## 四、 第三步：无线业务 (AC/AP配置 - 完整版)

### 1. AC 基础配置
```shell
[AC] vlan batch 100 20
[AC] interface vlanif 100
[AC-Vlanif100] ip address 192.168.100.1 24
[AC] capwap source interface vlanif 100
# 默认路由指向核心，否则 AC 找不到外网，也没法管理 VLAN 20 的流量
[AC] ip route-static 0.0.0.0 0 192.168.100.254 
```

### 2. AP 上线与业务配置 (一气呵成)
```shell
[AC] wlan
# 1. 创建安全模板 (密码 huawei@123)
[AC-wlan-view] security-profile name sec-corp
[AC-wlan-sec-prof-sec-corp] security wpa-wpa2 psk pass-phrase huawei@123 aes
[AC-wlan-sec-prof-sec-corp] quit

# 2. 创建 SSID 模板 (WIFI名字)
[AC-wlan-view] ssid-profile name ssid-corp
[AC-wlan-ssid-prof-ssid-corp] ssid Huawei-Corp
[AC-wlan-ssid-prof-ssid-corp] quit

# 3. 创建 VAP 模板 (绑定业务VLAN)
[AC-wlan-view] vap-profile name vap-corp
[AC-wlan-vap-prof-vap-corp] forward-mode direct-forward
[AC-wlan-vap-prof-vap-corp] service-vlan vlan-id 20
[AC-wlan-vap-prof-vap-corp] security-profile sec-corp
[AC-wlan-vap-prof-vap-corp] ssid-profile ssid-corp
[AC-wlan-vap-prof-vap-corp] quit

# 4. 创建 AP 组并应用 (让配置生效)
[AC-wlan-view] ap-group name default
[AC-wlan-ap-group-default] vap-profile vap-corp wlan 1 radio all
[AC-wlan-ap-group-default] quit
```

---

## 五、 第四步：出口安全与 NAT (通网)

### 1. 配置静态路由 (内网通出口)
```shell
[CoreSW] ip route-static 0.0.0.0 0 10.1.1.2 # 核心默认指向出口路由
```

### 2. 出口路由器 AR1
```shell
[AR1] interface g0/0/0
[AR1-GigabitEthernet0/0/0] ip address 10.1.1.2 24 # 连核心
[AR1] interface g0/0/1
[AR1-GigabitEthernet0/0/1] ip address 202.100.1.1 24 # 连外网
[AR1] ip route-static 192.168.0.0 16 10.1.1.1 # 回程路由：回内网怎么走
```

### 3. 配置 Easy-IP NAT
```shell
[AR1] acl 2000
[AR1-acl-basic-2000] rule permit source 192.168.0.0 0.0.255.255
[AR1] interface g0/0/1
[AR1-GigabitEthernet0/0/1] nat outbound 2000 # 只要是192.168开头的，全部转成公网IP上网
```

---

## 六、 进阶：高可用冗余 (VRRP + MSTP)

> **场景**：如果 CoreSW 坏了，网络就全断了。我们可以增加一台 `CoreSW2`。

### 1. VRRP (双机热备网关)
在两台核心交换机上配置虚拟网关：
```shell
# CoreSW (主)
[CoreSW-Vlanif10] vrrp vrid 1 virtual-ip 192.168.10.254
[CoreSW-Vlanif10] vrrp vrid 1 priority 120 (设为优先级高，成为老大)

# CoreSW2 (备)
[CoreSW2-Vlanif10] vrrp vrid 1 virtual-ip 192.168.10.254
# (默认优先级100，自动成为小弟)
```

### 2. MSTP (防环且负载均衡)
```shell
[CoreSW] stp region-configuration
[CoreSW-mst-region] region-name huawei
[CoreSW-mst-region] instance 1 vlan 10
[CoreSW-mst-region] active region-configuration
[CoreSW] stp instance 1 root primary (让 CoreSW 成为 VLAN 10 的树根)
```

---

## 七、 验证与避坑

### 1. 验证步骤 (不只是Ping)
1.  **终端连通性**: PC1 `ping 202.100.1.2`。如果通了，说明接入->核心->出口->NAT->外网全线贯通。
2.  **查看路由表**: 在 `CoreSW` 上输入 `display ip routing-table`，确认是否存在前往 0.0.0.0 的默认路由。
3.  **查看 NAT 转换**: 在 `AR1` 上输入 `display nat session all`。如果能看到内网私网地址转换为公网地址，说明 NAT 成功。
4.  **查看 AP 状态**: 在 `AC` 上输入 `display ap all`。确保 `State` 是 `nor`。
5.  **无线接入**: 手机 STA 搜 `Huawei-Corp` 连接，成功获取 IP。

### 2. 避坑指南 (必看)
*   **AP 离线**：检查核心交换机的 Option 43 有没有写 AC 的地址（必须是 192.168.100.1）。
*   **能 Ping 通网关但上不了网**：检查 AR1 路由器的“回程路由”是否配置正确：`ip route-static 192.168.0.0 16 10.1.1.1`。
*   **VLAN 透传**：确保 LSW1 到 CoreSW 之间的 Trunk 允许了所有业务 VLAN (10, 100) 通过。

---

## 七、 保存配置 (最后一步，必做!)

在所有设备上执行保存，防止断电丢失：
```shell
<LSW1> save
<CoreSW> save
<AC> save
<AR1> save
<ISP> save
```