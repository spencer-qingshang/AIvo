# 项目2 运用交换机构建小型园区网络 (官方大纲 13833 权威百科版)

> **修订说明**：本笔记严格对标自考大纲，涵盖所有“识记、领会、应用”知识点。
> **警告**：内容极度详细，请配合侧边栏目录阅读。

---

## 零、 交换机管理基础 (大纲新增点)

### 0.1 登录与管理方式 (识记)
*   **【官方定义】**：
    *   **本地管理**：通过 **Console** 口连接。波特率（Baud Rate）默认为 **9600**。
    *   **远程管理**：通过 **Telnet**（不加密）或 **SSH/STelnet**（加密）登录。
*   **【大白话】**：Console 就像是在服务器跟前连线；Telnet/SSH 就像是坐在家里远程桌面。
*   **【考试细节点】**：
    *   Console 线下进入设备，不需要 IP 地址。
    *   VTY (Virtual Type Terminal)：虚拟终端线路，默认华为设备支持 5~15 个并发用户。

---

## 一、 VLAN 技术深度解析 (VLAN Theory)

### 1.1 VLAN 的产生与划分方式 (识记/领会)
*   **核心价值**：隔离广播域、安全隔离、灵活组网。
*   **五种划分方式对比** (必考简答)：
    1.  **基于端口 (Port-based)**：最常用。优点：配置简单；缺点：电脑换插口需重新配置。
    2.  **基于 MAC 地址**：优点：终端移动不影响 VLAN；缺点：初始录入 MAC 成本高。
    3.  **基于子网 (IP Subnet-based)**：根据 IP 段划分。
    4.  **基于协议 (Protocol-based)**：区分 IPv4、IPv6 或 IPX。
    5.  **基于策略 (Policy-based)**：最高级，根据 MAC+IP+端口 组合。

### 1.2 802.1Q 帧结构 (填空题重灾区)
*   **TPID (16位/2字节)**：固定值 **0x8100**。
*   **PRI (3位)**：优先级，0-7。
*   **CFI (1位)**：标准格式指示位。
*   **VID (12位)**：VLAN ID。
    *   **计算**：$2^{12} = 4096$。
    *   **范围**：0-4095。可用 1-4094。VLAN 1 是 Default VLAN。

### 1.3 华为三种端口类型逻辑 (核心应用)
*   **PVID**：接口的默认 VLAN。如果收到的帧没标签，就给它打上 PVID。

| 端口类型 | 接收不带标签帧 | 接收带标签帧 | 发送 (Outbound) 逻辑 |
| :--- | :--- | :--- | :--- |
| **Access** | 打上 PVID 接收 | 标签=PVID则收，不等则丢弃 | **强行剥离标签**发送。 |
| **Trunk** | 打上 PVID，查 Allow 表 | 查 Allow 表，在则收，不在丢弃 | 1. VID=PVID：**剥标**发送。<br>2. VID!=PVID：**带标**发送。 |
| **Hybrid** | 打上 PVID，查列表 | 查列表 | **极其灵活**：根据配置决定 `tagged` (带标) 或 `untagged` (剥标)。 |

---

## 二、 STP/RSTP 环路保护协议

### 2.1 环路的代价 (领会)
*   **广播风暴**：广播包在环路中指数级倍增。
*   **MAC 地址表漂移**：同一个 MAC 地址由于从两个口进，导致交换机不停更新表项，CPU 爆表。

### 2.2 STP (802.1D) 选举全流程 (简答题标准步骤)
1.  **选举根桥 (Root Bridge)**：
    *   比 **BID (Bridge ID)**。BID = 优先级 + MAC。**越小越优**。
    *   优先级默认 **32768**。
2.  **选举根端口 (RP)**：
    *   在非根桥上选。顺序：**RPC (路径开销) -> 对端 BID -> 对端 PID -> 本端 PID**。
3.  **选举指定端口 (DP)**：
    *   在链路上选。顺序同 RP 选举。
4.  **状态迁移计时器**：
    *   Hello: 2s
    *   Max Age: 20s
    *   Forward Delay: 15s (状态切换间隔，两次共 30s)。

### 2.3 RSTP (802.1W) 的进化 (领会)
*   **端口角色新增**：
    *   **Alternate Port (备选端口)**：根端口的备份。
    *   **Backup Port (备份端口)**：指定端口的备份。
*   **端口状态合并**：
    *   Discarding (不学 MAC, 不转发)
    *   Learning (学 MAC, 不转发)
    *   Forwarding (全功能)
*   **边缘端口 (Edge Port)**：插线即通，不参与计算，不产生拓扑改变。

---

## 三、 三层交换与 VLAN 间路由

### 3.1 三层转发原理 (识记)
*   **“一次路由，多次交换”**：第一个包由路由引擎处理，建立 **FIB (转发信息表)**，后续包直接由硬件 ASIC 芯片转发。
*   **VLANIF 接口**：交换机为 VLAN 提供的逻辑三层接口。只要该 VLAN 下有一个物理口 Up，VLANIF 就是 Up 的。

### 3.2 路由器 vs 三层交换机
*   **路由器**：功能多（NAT/VPN/QoS），软件转发慢，用于网络出口。
*   **三层交换机**：功能专注，硬件转发极快，用于园区核心。

---

## 四、 链路聚合 Eth-Trunk

### 4.1 核心价值
*   **增加带宽**：聚合多条链路。
*   **负载分担**：基于源/目的 MAC 或 IP 进行流量分配。

### 4.2 LACP 模式细节
*   **系统优先级**：决定谁是“主动端”。默认 **32768**，越小越优。
*   **活动接口上限**：可以配置最大活动接口数，多余的作为备份。

---

## 五、 VRRP 网关高可用协议 (重点)

### 5.1 基础概念 (识记/领会)
*   **目的**：解决单网关（Single Point of Failure）故障。
*   **虚拟 MAC 地址格式**：**00-00-5E-00-01-{VRID}** (必考填空)。
*   **角色选举**：比较优先级。默认 **100**。**越大越优** (注意：这里是越大越优！)。

### 5.2 工作机制
*   **Master**：响应 ARP，转发流量。
*   **Backup**：只听 Master 的 Advertisement 报文。如果连续 **3个间隔** 没听到，则抢占。
*   **抢占模式 (Preempt)**：优先级高的恢复后，会强制夺回 Master 身份。

---

## 六、 DHCP 动态配置服务 (深度)

### 6.1 DORA 四步过程 (简答)
1.  **Discover** (广播)：客户端找服务器。
2.  **Offer** (单播/广播)：服务器送出 IP。
3.  **Request** (广播)：客户端“官宣”接受。
4.  **Ack** (单播/广播)：服务器确认，分配成功。

### 6.2 租约更新机制 (填空)
*   **T1 (50% 租期)**：客户端尝试续约。
*   **T2 (87.5% 租期)**：如果 T1 没成功，客户端广播寻找任何可用的服务器。

---

## 七、 交换机物理特性 (补充)

### 7.1 双工与速率
*   **Duplex**：
    *   Full-duplex (全双工)：同时收发。
    *   Half-duplex (半双工)：不能同时收发（如集线器）。
    *   Auto (自协商)。
*   **MAC 地址表**：
    *   **动态项**：学习而来，默认老化时间 **300秒**。
    *   **静态项**：手工配，不消失。
    *   **黑洞项**：丢弃指定 MAC。

---

## 🛠️ 13833 大纲要求核心配置模板

```shell
# 1. 基础 VLAN 与 批量端口处理
vlan batch 10 20
interface range g0/0/1 to g0/0/10  # 批量进入
 port link-type access
 port default vlan 10

# 2. 三层交换网关 (VLANIF)
interface Vlanif 10
 ip address 192.168.10.1 24

# 3. VRRP 主备设置 (Master)
interface Vlanif 10
 vrrp vrid 1 virtual-ip 192.168.10.254
 vrrp vrid 1 priority 120   # 优先级大者为主

# 4. DHCP 开启 (全局池模式)
dhcp enable
ip pool OFFICE
 network 192.168.10.0 mask 255.255.255.0
 gateway-list 192.168.10.1
 dns-list 8.8.8.8
interface Vlanif 10
 dhcp select global

# 5. STP 优化
stp mode rstp
stp root primary           # 自动计算优先级为 0
interface g0/0/1
 stp edged-port enable     # 设为边缘端口
```
