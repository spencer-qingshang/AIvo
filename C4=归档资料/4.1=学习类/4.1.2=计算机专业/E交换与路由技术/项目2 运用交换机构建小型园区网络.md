# 项目2 运用交换机构建小型园区网络 (大纲全覆盖精讲版)

> **复习指导**：本项目是全书最核心章节，分值占比极高（约 30-40 分）。
> 请务必掌握 **VLAN 标签处理逻辑**、**STP 选举过程**、**VRRP 主备切换原理**。

---

## 第一部分：VLAN 技术 (虚拟局域网)

### 1.1 基础概念 (识记)
*   **定义**：VLAN (Virtual Local Area Network) 将一个物理局域网逻辑上划分为多个广播域。
*   **目的**：**隔离广播风暴**、增强安全性、简化网络管理。
*   **划分方式**：
    *   **基于端口** (最常用，本课程重点)。
    *   基于 MAC 地址 (移动性好，但配置麻烦)。
    *   基于 IP 子网。
    *   基于协议。

### 1.2 802.1Q 帧格式 (填空题高频)
*   **协议标准**：**IEEE 802.1Q**。
*   **Tag 位置**：源 MAC 地址 (Source MAC) 和 类型 (Type) 字段之间。
*   **Tag 长度**：**4 字节**。
    *   **TPID**：0x8100，标识这是 VLAN 帧。
    *   **PRI**：优先级 (3位)，用于 QoS。
    *   **CFI**：规范格式指示符 (1位)。
    *   **VID (VLAN ID)**：**12位**。
*   **VLAN ID 范围**：**0 ~ 4095**。
    *   **0, 4095**：保留，不可用。
    *   **1**：系统默认 VLAN (所有接口默认属于 VLAN 1)。
    *   **1 ~ 4094**：用户可用。

### 1.3 链路类型与处理逻辑 (应用/简答 - 必考死记)

| 接口类型 | 连接对象 | 接收 (Inbound) | 发送 (Outbound) | 关键点 |
| :--- | :--- | :--- | :--- | :--- |
| **Access** | PC/服务器 | 收无标签帧 -> **打上 PVID** | 检查标签=PVID -> **剥离标签**发送 | **进打标，出剥离** |
| **Trunk** | 交换机/路由器 | 1. 有标签且在 Allow 表 -> 透传<br>2. 无标签 -> 打上 PVID | 1. 标签在 Allow 表且 **!= PVID** -> **带标签**发<br>2. 标签在 Allow 表且 **== PVID** -> **剥离**发 | **透传为主，PVID特殊** |
| **Hybrid** | 灵活场景 | 同 Trunk | **可手动配置**哪些 VLAN 剥离(Untagged)，哪些带标签(Tagged) | **华为默认接口类型** |

---

## 第二部分：STP/RSTP 生成树协议

### 2.1 STP (802.1d) 基础 (识记)
*   **背景**：为了链路冗余（备份）连接了多根线，导致**物理环路**。环路会引发**广播风暴**、**MAC 表震荡**。
*   **作用**：逻辑上阻塞端口，消除环路。
*   **BPDU**：桥协议数据单元，每 **2秒** 发送一次。

### 2.2 STP 选举过程 (简答题背诵)
**口诀：一屋不容二主，先选老大，再选路。**
1.  **选根桥 (Root Bridge)**：
    *   比较 **桥ID (Bridge ID)** = 优先级(2字节) + MAC(6字节)。
    *   **越小越优**。
    *   默认优先级 **32768**，步长 **4096**。
2.  **选根端口 (RP)**：
    *   非根交换机上，去往根桥路径开销 (Cost) 最小的端口。
3.  **选指定端口 (DP)**：
    *   每一条链路上，离根桥最近的端口。
4.  **阻塞端口 (AP)**：
    *   剩下的端口逻辑阻塞 (Block)。

### 2.3 STP 端口状态 (填空)
*   **Disabled** (禁用)
*   **Blocking** (阻塞)：只收 BPDU，不发数据。
*   **Listening** (侦听)：选出根桥，准备通过。
*   **Learning** (学习)：学习 MAC 地址。
*   **Forwarding** (转发)：正常转发数据。
*   **收敛时间**：从 Blocking 到 Forwarding 需 **30-50秒**。

### 2.4 RSTP (802.1w) 快速生成树 (领会)
*   **改进点**：
    *   **收敛快**：P/A (Proposal/Agreement) 机制，秒级收敛。
    *   **状态简化**：只有 Discarding, Learning, Forwarding。
    *   **边缘端口 (Edge Port)**：连接 PC 的端口设为边缘端口，**不参与生成树计算，插线即通** (0延迟)。

---

## 第三部分：链路聚合 (Eth-Trunk)

### 3.1 基础概念 (识记)
*   **定义**：将多个物理接口捆绑为一个逻辑接口。
*   **优势**：增加带宽、提高可靠性、负载分担。
*   **条件**：接口速率、双工模式、介质类型必须一致。

### 3.2 工作模式
*   **手工模式 (Manual)**：所有链路全开，不检测对端状态。
*   **LACP 模式** (802.3ad)：
    *   通过 LACPDU 报文协商。
    *   支持 **M:N 备份** (M 条活动，N 条备份)。
    *   根据 **系统优先级** (越小越优) 确定主动端。

---

## 第四部分：VLAN 间路由 (三层交换)

### 4.1 二层与三层的区别 (简答)
*   **二层交换机**：只认 MAC 地址，无法跨 VLAN 通信。
*   **三层交换机**：集成路由功能，通过 **VLANIF** 接口实现跨 VLAN 通信。

### 4.2 虚接口 (VLANIF)
*   每个 VLAN 对应一个 VLANIF 接口。
*   配置 IP 地址，作为该 VLAN 下终端设备的 **网关 (Gateway)**。

---

## 第五部分：高可靠性与服务 (VRRP & DHCP)

### 5.1 VRRP 虚拟路由冗余协议 (领会/应用)
*   **场景**：网关备份。如果只有一个网关 (192.168.1.1) 坏了，全网断网。VRRP 搞出一台“虚拟路由器”。
*   **角色**：
    *   **Master (主)**：实际转发数据，定期发送 VRRP 通告。
    *   **Backup (备)**：监听通告，Master 挂了立刻接替。
*   **选举**：比较 **优先级** (默认 100)。**越大越优**。
*   **虚拟 IP**：终端电脑填写的网关地址 (VIP)。

### 5.2 DHCP 动态主机配置协议 (领会)
*   **作用**：自动给电脑分配 IP、掩码、网关、DNS。
*   **四步交互 (DORA)**：
    1.  **Discover** (发现)：客户端广播“谁有 IP？”
    2.  **Offer** (提供)：服务器单播/广播“我有，给你这个。”
    3.  **Request** (请求)：客户端广播“好的，我要用这个了。”
    4.  **Ack** (确认)：服务器单播/广播“确认生效。”
*   **配置模式**：
    *   **接口模式**：直接在 VLANIF 接口下开启。
    *   **全局模式**：建立地址池 (IP Pool)。

---

## 第六部分：核心配置命令清单 (背诵)

### 1. 基础 VLAN 与 Trunk
```shell
[Huawei] vlan batch 10 20
[Huawei] interface g0/0/1
[Huawei-G0/0/1] port link-type access
[Huawei-G0/0/1] port default vlan 10
[Huawei] interface g0/0/24
[Huawei-G0/0/24] port link-type trunk
[Huawei-G0/0/24] port trunk allow-pass vlan all
```

### 2. 三层交换 + DHCP
```shell
[Huawei] dhcp enable
[Huawei] interface vlanif 10
[Huawei-Vlanif10] ip address 192.168.10.1 24
[Huawei-Vlanif10] dhcp select interface  # 开启接口 DHCP
```

### 3. RSTP 边缘端口
```shell
[Huawei] stp mode rstp
[Huawei] interface g0/0/1
[Huawei-G0/0/1] stp edged-port enable    # 连接 PC 的口开启
```

### 4. VRRP 配置 (在 VLANIF 下)
```shell
[Huawei-Vlanif10] vrrp vrid 1 virtual-ip 192.168.10.254  # 虚拟网关
[Huawei-Vlanif10] vrrp vrid 1 priority 120              # 设为主(默认100)
```
