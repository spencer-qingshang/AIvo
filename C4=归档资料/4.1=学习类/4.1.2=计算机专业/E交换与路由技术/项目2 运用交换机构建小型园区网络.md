# 项目2：运用交换机构建小型园区网络 (新手实战版)

## 0. 项目大纲
### 1. 交换机基本配置
*   **识记**：交换机管理方式；Console端口登录管理；交换机命令视图模式。
*   **领会**：交换机端口类型；交换机端口双工模式；交换机端口速率。
*   **应用**：交换机的基础配置。
### 2. 实现不同部门之间网络隔离
*   **识记**：VLAN技术简介；VLAN帧格式；VLAN划分方式。
*   **领会**：VLAN技术优缺点。
*   **应用**：VLAN技术工作原理；VLAN技术关键命令格式。
### 3. 实现相同部门跨交换机互访
*   **识记**：链路类型；端口类型；不同类型的端口接收报文时的处理方式；不同类型的端口发送报文时的处理方式。
*   **领会**：Trunk链路的作用；Access端口和Trunk端口的区别。
*   **应用**：跨交换机VLAN的工作原理；Access端口和Trunk端口的配置命令；实现不同交换机间相同VLAN下计算机通讯的配置。
### 4. 利用三层交换机实现部门间网络互访
*   **识记**：三层交换机；三层交换机与二层交换机的区别。
*   **领会**：三层交换机与路由器的区别；三层交换机路由工作原理。
*   **应用**：计算机与交换机、路由器之间的连接；VLAN间路由配置；VLAN配置。
### 5. 提高骨干链路带宽
*   **识记**：链路聚合。
*   **领会**：链路聚合的优势。
*   **应用**：链路聚合的配置。
### 6. 避免网络环路
*   **识记**：网络环路；STP；RSTP。
*   **领会**：网络环路产生的原理；STP与RSTP的基本原理和工作过程。
*   **应用**：RSTP的配置。
### 7. 提高网络稳定性
*   **识记**：VRRP相关术语；虚拟路由器。
*   **领会**：VRRP的作用和工作过程。
*   **应用**：VRRP的配置；Tracert命令配置与作用。
### 8. 实现部门部门计算机动态获取地址
*   **识记**：DNS地址；IP地址冲突；DHCP技术。
*   **领会**：DHCP技术作用。
*   **应用**：DHCP配置；DHCP服务故障排查。

## 一、 项目背景：为一家初创公司组网
假设你现在是公司的网管。公司有两层楼，两个部门：**财务部**（比较机密）和**技术部**（比较开放）。
*   **需求1**：所有人的电脑都能连上公司网络。
*   **需求2**：为了安全，**财务部的电脑不能让技术部的人访问**（网络隔离）。
*   **需求3**：虽然财务部分布在两层楼，但他们之间必须能互相访问（跨楼层互通）。

为了实现这些需求，我们需要使用**交换机 (Switch)** 和 **VLAN (虚拟局域网)** 技术。

---

## 二、 环境准备与规划 (关键!)

### 1. 物理拓扑
*   **交换机**: S5700 或 S3700 (SW1, SW2)
*   **PC**: 4台 (PC1, PC2, PC3, PC4)

### 2. IP地址与VLAN规划表
**请先按照下表配置好你的PC，这是实验成功的前提！**

| 设备 | 接口/位置 | 所属VLAN | IP地址 | 子网掩码 | 默认网关 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **PC1** | 接 SW1 1号口 | VLAN 10 (财务) | 192.168.10.1 | 255.255.255.0 | 192.168.10.254 |
| **PC2** | 接 SW1 3号口 | VLAN 20 (技术) | 192.168.20.1 | 255.255.255.0 | 192.168.20.254 |
| **PC3** | 接 SW2 1号口 | VLAN 10 (财务) | 192.168.10.2 | 255.255.255.0 | 192.168.10.254 |
| **PC4** | 接 SW2 3号口 | VLAN 20 (技术) | 192.168.20.2 | 255.255.255.0 | 192.168.20.254 |
| **SW1** | Vlanif 10/20 | - | .254 (网关) | 24 | - |

---

## 三、 核心概念：VLAN (虚拟局域网)
> **通俗解释**：
> 默认情况下，插在同一个交换机上的所有电脑都能互相说话，这就像大家都在一个没有任何隔断的大通铺办公。
> **VLAN** 就像是在大通铺里起了几堵**玻璃墙**，把不同部门的人隔开。
> *   VLAN 10：财务部的专属房间。
> *   VLAN 20：技术部的专属房间。
> *   虽然大家物理上还插在同一台交换机上，但VLAN 10的人发出的消息，VLAN 20的人根本听不到。

---

## 四、 任务实战详解

### 任务1：交换机基本配置
#### 1.1 交换机管理方式 (识记)
*   **本地管理**：通过 **Console端口** 使用 Console 线缆连接电脑。这是新设备首次配置的唯一方式。
*   **远程管理**：配置好 IP 地址后，通过 **Telnet** 或 **SSH** 远程登录。

#### 1.2 交换机基础操作与视图 (识记/应用)
*   **视图模式回顾**：用户视图 `< >` -> 系统视图 `[ ]` -> 接口/协议视图。
*   **双工模式 (领会)**：
    *   **Full-duplex (全双工)**：同时收发，互不干扰。
    *   **Half-duplex (半双工)**：同一时间只能收或发（如老式集线器 Hub）。
*   **接口速率 (领会)**：常见有 10M/100M/1000M(GE)/10000M(10GE)。通常设为 `auto` (自协商)。

#### 1.3 基础配置命令 (应用)
```shell
<Huawei> system-view
[Huawei] sysname SW1
[SW1] interface GigabitEthernet 0/0/1
[SW1-GigabitEthernet0/0/1] description link_to_PC1  # 端口描述
[SW1-GigabitEthernet0/0/1] speed 100               # 手动设速率(可选)
[SW1-GigabitEthernet0/0/1] duplex full            # 手动设全双工(可选)
```

---

### 任务2：实现不同部门之间网络隔离 (VLAN)
#### 2.1 VLAN 基础 (识记)
*   **VLAN简介**：Virtual Local Area Network（虚拟局域网），将一个物理局域网逻辑上划分为多个广播域。
*   **VLAN划分方式**：
    1.  **基于端口**：最常用，把接口分给 VLAN（本实验采用）。
    2.  **基于MAC地址**：看电脑网卡，电脑插哪个口都属于同一个 VLAN。
    3.  **基于子网/协议**：较少见。
*   **VLAN帧格式 (识记)**：在标准的以太网帧中加入 **802.1Q Tag**（4字节），包含 VLAN ID（12位，范围 0-4095，可用 1-4094）。

#### 2.2 VLAN 的优缺点 (领会)
*   **优点**：隔离广播域（减少垃圾信息）、提高安全性、简化网络管理、不受地理位置限制。
*   **缺点**：增加了配置复杂度、跨 VLAN 通信需要三层设备。

#### 2.3 划分部门配置 (应用)
**场景**：把 1-2 号口分给财务部 (VLAN 10)，3-4 号口分给技术部 (VLAN 20)。
```shell
[SW1] vlan 10
[SW1-vlan10] quit
[SW1] interface GigabitEthernet 0/0/1
[SW1-GigabitEthernet0/0/1] port link-type access
[SW1-GigabitEthernet0/0/1] port default vlan 10
```

---

### 任务3：实现相同部门跨交换机互访 (Trunk)
#### 3.1 链路与端口类型 (识记)
*   **链路类型**：
    *   **接入链路 (Access Link)**：传输不带 Tag 的帧，连接 PC。
    *   **干道链路 (Trunk Link)**：传输带 Tag 的帧，连接交换机。
*   **端口收发报文处理方式 (识记/领会)**：
    | 端口类型 | 接收报文 | 发送报文 |
    | :--- | :--- | :--- |
    | **Access** | 接收不带 Tag 的帧，打上 PVID（接口默认VLAN）标签。 | 若 Tag 与 PVID 相同，剥掉 Tag 发送；不同则丢弃。 |
    | **Trunk** | 接收带 Tag 的帧：若 VLAN 在允许列表中则保留 Tag 接收；若不在则丢弃。接收不带 Tag 的帧：打上 PVID 标签接收。 | 若 VLAN 在允许列表中：且 VLAN ID 等于 PVID，剥掉 Tag 发送；若不等，带原有 Tag 发送。 |

#### 3.2 Access 与 Trunk 的区别 (领会)
*   **Access**：进门贴标签，出门撕标签；只能属于 1 个 VLAN。
*   **Trunk**：标签快递员，允许 1 个或多个 VLAN 带着标签过路。

#### 3.3 跨交换机配置命令 (应用)
```shell
[SW1] interface GigabitEthernet 0/0/24
[SW1-GigabitEthernet0/0/24] port link-type trunk
[SW1-GigabitEthernet0/0/24] port trunk allow-pass vlan 10 20
```

---

### 任务4：利用三层交换机实现部门间互访
#### 4.1 二层、三层与路由器的区别 (识记/领会)
*   **二层交换机**：只看 MAC 地址，只能在同一个 VLAN 里转数据。
*   **三层交换机**：本质是“二层交换 + 三层转发”。能看 IP 地址，实现 VLAN 间路由。
    *   **区别路由器**：三层交换机主要通过硬件（ASIC）查表转发，速度极快（一次路由，多次交换）；路由器功能更丰富（NAT、VPN、防火墙），更适合外网出口。
*   **三层转发原理**：当跨 VLAN 通信时，第一个包由三层引擎查找路由表，后续流量则直接在硬件芯片层按 MAC/IP 绑定关系快速交换。

#### 4.2 VLAN 间路由配置 (应用)
```shell
[SW1] interface vlanif 10
[SW1-Vlanif10] ip address 192.168.10.254 24
[SW1] interface vlanif 20
[SW1-Vlanif20] ip address 192.168.20.254 24
```
**注意**：PC 的网关必须指向对应的 Vlanif 地址。

---

### 任务5：提高骨干链路带宽 (链路聚合)
#### 5.1 链路聚合/Eth-Trunk (识记/领会)
*   **定义**：将多个物理以太网接口捆绑成一个逻辑接口。
*   **优势**：
    1.  **带宽叠加**：两根 1G 线变一根 2G 逻辑线。
    2.  **负载分担**：数据分流在不同物理线上。
    3.  **高可靠性**：断开一条线，业务不中断（只要还有一根通）。

#### 5.2 链路聚合配置 (应用)
```shell
[SW1] interface Eth-Trunk 1             # 创建聚合组 1
[SW1-Eth-Trunk1] mode manual load-balance  # 手动负载分担模式
[SW1-Eth-Trunk1] trunkport GigabitEthernet 0/0/23 to 0/0/24 # 加入端口
# 之后对 Eth-Trunk 1 进行 Trunk 配置即可
[SW1-Eth-Trunk1] port link-type trunk
[SW1-Eth-Trunk1] port trunk allow-pass vlan all
```

---

### 任务6：避免网络环路 (STP/RSTP)
#### 6.1 环路产生原理 (识记/领会)
*   **产生原因**：为了冗余备份，交换机间连了两根以上的线，形成了环（Loop）。
*   **后果**：**广播风暴**（数据无限转圈）、MAC 地址表漂移（设备发疯）。

#### 6.2 STP 与 RSTP 原理 (识记/领会)
*   **STP (生成树协议)**：通过阻塞某个端口，把环状网络逻辑上变成树状。
*   **RSTP (快速生成树协议)**：STP 的升级版。STP 收敛慢（30-50秒），RSTP 实现秒级收敛，响应更快。
*   **工作过程**：选出根桥（老大交换机）-> 选出根端口 -> 选出指定端口 -> 阻塞多余端口。

#### 6.3 RSTP 配置 (应用)
```shell
[SW1] stp mode rstp             # 切换到 RSTP 模式
[SW1] stp root primary          # (可选) 强制将 SW1 设为老大(根桥)
[SW1] stp enable               # 开启生成树(华为默认已开启)
```

---

### 任务7：提高网络稳定性 (VRRP)
#### 7.1 VRRP 与虚拟路由器 (识记/领会)
*   **定义**：虚拟路由冗余协议 (Virtual Router Redundancy Protocol)。
*   **虚拟路由器**：多台物理路由器通过 VRRP 虚拟出一台“假”路由器（Virtual Router），有一个 **虚拟 IP (VIP)**。
*   **作用**：当主网关挂掉时，备用网关瞬间顶上，PC 端感知不到网络中断。

#### 7.2 VRRP 配置 (应用)
```shell
# 在 SW1 (主)
[SW1-Vlanif10] vrrp vrid 1 virtual-ip 192.168.10.254  # 设置虚拟网关
[SW1-Vlanif10] vrrp vrid 1 priority 120              # 优先级调高，成为主(Master)

# 在 SW2 (备)
[SW2-Vlanif10] vrrp vrid 1 virtual-ip 192.168.10.254  # 虚拟 IP 必须一致
# 默认优先级 100，成为备(Backup)
```

#### 7.3 Tracert 命令 (应用)
*   **作用**：追踪路由路径。
*   **命令**：`tracert 192.168.20.1`。
*   **意义**：查看数据包到底是从 SW1 走的还是 SW2 走的，用于 VRRP 故障排查。

---

### 任务8：实现计算机动态获取地址 (DHCP)
#### 8.1 DHCP 技术 (识记/领会)
*   **核心作用**：自动分配 IP、子网掩码、网关、**DNS 地址**（将域名解析为 IP 的服务器地址）。
*   **IP 地址冲突 (识记)**：同一个局域网内两台电脑用了同一个 IP。DHCP 通过检测机制避免分配冲突。

#### 8.2 DHCP 配置 (应用)
```shell
[SW1] dhcp enable                 # 开启全局 DHCP 功能
[SW1] ip pool pool1               # 创建地址池
[SW1-ip-pool-pool1] network 192.168.10.0 mask 24
[SW1-ip-pool-pool1] gateway-list 192.168.10.254
[SW1-ip-pool-pool1] dns-list 8.8.8.8
[SW1-ip-pool-pool1] quit
[SW1] interface vlanif 10
[SW1-Vlanif10] dhcp select global # 在接口开启 DHCP 全局分配模式
```

#### 8.3 故障排查 (应用)
*   PC 拿不到地址？检查 `dhcp enable` 了吗？地址池里的 `network` 和接口 VLAN 是一个段吗？
*   使用 `display ip pool name pool1` 查看地址分配情况。

---

## 五、 验证与保存 (大功告成)

### 1. 连通性测试 (Ping)
*   **同部门互通**：PC1 Ping PC3 -> **通** (192.168.10.1 -> 192.168.10.2)。
*   **跨部门互通**：PC1 Ping PC2 -> **通** (192.168.10.1 -> 192.168.20.1)。
    *   *说明*：这需要任务3配置好VLANIF才行。如果只做完任务2，是不通的。

### 2. 保存配置
```shell
<SW1> save
<SW2> save
```

---

## 七、 新手避坑与命令速查表

| 场景 | 关键命令 | 解释 |
| :--- | :--- | :--- |
| **查VLAN** | `display vlan` | 查看建了哪些VLAN，哪些口在里面 |
| **查接口** | `display port vlan` | **最常用！** 查看接口是Access还是Trunk，以及允许了哪些VLAN |
| **配错口了** | `undo port default vlan` | 命令前加 `undo` 就是取消配置 |
| **恢复出厂** | `reset saved-configuration` | 清空所有配置，重启后生效 |

### 常见错误
1.  **Access配成了Trunk**：
    *   现象：电脑连上去不通。
    *   解决：先 `undo port link-type` 恢复默认，再重新配。
2.  **Trunk忘记放行VLAN**：
    *   现象：两个交换机下的同部门电脑不通。
    *   检查：`display port vlan` 看 Trunk 口的 `Link Type` 和 `PVID` 以及 `Trunk VLAN List`。
3.  **忘记配网关**：
    *   现象：PC可以Ping通同VLAN的人，Ping不通其他VLAN。
    *   解决：检查PC设置里的“默认网关”填没填，以及交换机的 `interface vlanif` 配没配。
